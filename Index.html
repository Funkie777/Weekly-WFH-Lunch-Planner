<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WFH Lunch Planner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; padding: 20px; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; margin-bottom: 10px; font-size: 28px; }
        .subtitle { color: #7f8c8d; margin-bottom: 30px; font-size: 14px; }
        .controls { margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 6px; display: flex; flex-wrap: wrap; gap: 10px; }
        button { background: #2980b9; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500; }
        button:hover { opacity: 0.88; }
        .print-btn { background: #3498db; }
        .download-btn { background: #8e44ad; }
        .meal-card { margin-bottom: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 6px; background: #fafafa; }
        .meal-card.hidden { display: none; }
        .meal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; gap: 10px; }
        .meal-header-left { display: flex; align-items: center; gap: 12px; }
        .meal-checkbox { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; }
        .meal-title { font-size: 20px; font-weight: 600; color: #2c3e50; }
        .prep-tag { font-size: 11px; background: #2980b9; color: white; padding: 2px 7px; border-radius: 3px; margin-left: 8px; vertical-align: middle; }
        .meal-content { margin-top: 15px; }
        .section-title { font-weight: 600; color: #34495e; margin-top: 15px; margin-bottom: 8px; font-size: 16px; }
        .ingredients-list, .method-list { list-style-position: inside; color: #555; }
        .ingredients-list li { margin-bottom: 4px; list-style-type: none; padding-left: 20px; position: relative; }
        .ingredients-list li:before { content: "•"; position: absolute; left: 5px; }
        .method-list li { margin-bottom: 8px; padding-left: 5px; }
        .shopping-list { margin-top: 30px; padding: 20px; background: #eaf4fb; border: 2px solid #2980b9; border-radius: 6px; }
        .shopping-list h2 { color: #1a6a9a; margin-bottom: 15px; font-size: 22px; }
        .shopping-category { margin-bottom: 15px; }
        .category-name { font-weight: 600; color: #34495e; margin-bottom: 6px; font-size: 15px; }
        .shopping-items { list-style: none; padding-left: 15px; }
        .shopping-items li { margin-bottom: 3px; color: #555; font-size: 14px; }
        .search-box { width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; }
        .search-box:focus { outline: none; border-color: #2980b9; }
        .macros { display: flex; gap: 6px; flex-wrap: wrap; }
        .macro-badge { background: #2980b9; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap; }
        .macro-badge.protein { background: #e74c3c; }
        .macro-badge.carbs { background: #f39c12; }
        .macro-badge.fat { background: #7f8c8d; }
        .prep-note { background: #eaf4fb; border-left: 3px solid #2980b9; padding: 8px 12px; margin-top: 12px; font-size: 13px; color: #555; border-radius: 0 4px 4px 0; }
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; padding: 20px; }
            .controls, .search-box { display: none; }
            .meal-card { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WFH Lunch Planner</h1>
        <p class="subtitle">8 high-protein lunches | All macros per serving (serves 2) | Made the night before | MFP Quick Add Ready | Macros verified from ingredients</p>
        <input type="text" class="search-box" id="searchBox" placeholder="Search lunches by name (e.g., chicken, tuna, rice)...">
        <div class="controls">
            <button onclick="generateWeek()">Generate 2 Lunches</button>
            <button onclick="showAll()">Show All 8 Lunches</button>
            <button class="print-btn" onclick="window.print()">Print</button>
            <button class="download-btn" onclick="downloadSelected()">Download Selected</button>
            <button class="download-btn" onclick="downloadGroceryList()">Download Grocery List</button>
        </div>
        <div id="meals"></div>
        <div id="shopping"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        let currentMeals = [];

        const mealDatabase = [
            {
                name: "Chicken Caesar Wrap",
                calories: 719, protein: 52, carbs: 32, fat: 38,
                prepNote: "Cook and slice chicken the night before. Assemble wraps in the morning and refrigerate.",
                ingredients: [
                    { item: "Chicken breasts", qty: "300g", category: "Meat & Fish" },
                    { item: "Large wraps", qty: "2", category: "Cooking" },
                    { item: "Caesar dressing", qty: "60g", category: "Cooking" },
                    { item: "Parmesan", qty: "60g", category: "Dairy" },
                    { item: "Romaine lettuce", qty: "100g", category: "Vegetables" },
                    { item: "Avocado", qty: "1 large", category: "Vegetables" },
                    { item: "Olive oil", qty: "1 tbsp", category: "Cooking" },
                    { item: "Salt and pepper", qty: "To taste", category: "Cooking" }
                ],
                method: [
                    "Season chicken breasts with salt and pepper. Heat olive oil in pan over medium-high heat.",
                    "Cook chicken for 6-7 minutes each side until golden and cooked through. Rest for 5 minutes then slice.",
                    "Shred romaine lettuce. Slice avocado.",
                    "Lay wraps flat. Spread caesar dressing over each wrap.",
                    "Layer lettuce, sliced chicken, avocado, and grated parmesan.",
                    "Roll tightly, wrap in foil or cling film and refrigerate overnight.",
                    "Slice in half to serve."
                ]
            },
            {
                name: "Prawn and Avocado Rice Bowl",
                calories: 804, protein: 43, carbs: 69, fat: 37,
                prepNote: "Cook rice and boil eggs the night before. Assemble bowls in the morning, keep dressing separate.",
                ingredients: [
                    { item: "Cooked king prawns", qty: "300g", category: "Meat & Fish" },
                    { item: "Basmati rice", qty: "150g uncooked", category: "Cooking" },
                    { item: "Avocados", qty: "2 medium", category: "Vegetables" },
                    { item: "Eggs", qty: "4 (for 2 per person)", category: "Dairy" },
                    { item: "Cucumber", qty: "100g", category: "Vegetables" },
                    { item: "Spring onions", qty: "4", category: "Vegetables" },
                    { item: "Soy sauce", qty: "2 tbsp", category: "Cooking" },
                    { item: "Sesame oil", qty: "1 tbsp", category: "Cooking" },
                    { item: "Lime", qty: "1", category: "Vegetables" },
                    { item: "Sesame seeds", qty: "1 tbsp", category: "Cooking" }
                ],
                method: [
                    "Cook rice according to packet instructions. Cool and refrigerate overnight.",
                    "Soft boil eggs for 6-7 minutes. Cool in cold water, peel and refrigerate.",
                    "Slice cucumber and spring onions. Refrigerate.",
                    "To assemble: divide cold rice between bowls.",
                    "Top with prawns, sliced avocado, cucumber, halved eggs, and spring onions.",
                    "Mix soy sauce, sesame oil, and lime juice for dressing.",
                    "Drizzle dressing over bowl and scatter sesame seeds to serve."
                ]
            },
            {
                name: "Beef and Quinoa Tabbouleh",
                calories: 742, protein: 49, carbs: 53, fat: 33,
                prepNote: "Cook beef and quinoa the night before. Chop herbs and veg in the morning. Tastes better the next day.",
                ingredients: [
                    { item: "Beef mince (5% fat)", qty: "300g", category: "Meat & Fish" },
                    { item: "Quinoa", qty: "150g uncooked", category: "Cooking" },
                    { item: "Cucumber", qty: "1 medium", category: "Vegetables" },
                    { item: "Cherry tomatoes", qty: "200g", category: "Vegetables" },
                    { item: "Feta cheese", qty: "60g", category: "Dairy" },
                    { item: "Fresh parsley", qty: "Large bunch", category: "Fresh Herbs" },
                    { item: "Fresh mint", qty: "Small bunch", category: "Fresh Herbs" },
                    { item: "Lemons", qty: "2", category: "Vegetables" },
                    { item: "Olive oil", qty: "2 tbsp", category: "Cooking" },
                    { item: "Salt and pepper", qty: "To taste", category: "Cooking" }
                ],
                method: [
                    "Cook quinoa according to packet instructions. Spread on tray to cool, then refrigerate.",
                    "Heat 1 tbsp oil in pan, cook beef mince for 8-10 minutes until browned. Season well. Cool and refrigerate.",
                    "Dice cucumber and halve cherry tomatoes. Finely chop parsley and mint.",
                    "Combine cold quinoa, beef, cucumber, tomatoes, and herbs in a large bowl.",
                    "Dress with remaining olive oil and lemon juice. Season to taste.",
                    "Crumble feta over the top.",
                    "Cover and refrigerate. Serve cold straight from the fridge."
                ]
            },
            {
                name: "Greek Chicken Bowl with Tzatziki",
                calories: 783, protein: 58, carbs: 68, fat: 28,
                prepNote: "Marinate and cook chicken the night before. Assemble cold bowls in the morning.",
                ingredients: [
                    { item: "Chicken breasts", qty: "2 (400g)", category: "Meat & Fish" },
                    { item: "Basmati rice", qty: "150g uncooked", category: "Cooking" },
                    { item: "Tzatziki", qty: "150g", category: "Dairy" },
                    { item: "Feta cheese", qty: "60g", category: "Dairy" },
                    { item: "Cucumber", qty: "100g", category: "Vegetables" },
                    { item: "Cherry tomatoes", qty: "150g", category: "Vegetables" },
                    { item: "Red onion", qty: "Half", category: "Vegetables" },
                    { item: "Olive oil", qty: "2 tbsp", category: "Cooking" },
                    { item: "Dried oregano", qty: "1 tsp", category: "Cooking" },
                    { item: "Lemon", qty: "1", category: "Vegetables" },
                    { item: "Garlic cloves", qty: "2", category: "Vegetables" },
                    { item: "Salt and pepper", qty: "To taste", category: "Cooking" }
                ],
                method: [
                    "Mix olive oil, oregano, crushed garlic, lemon juice, salt and pepper. Coat chicken and marinate overnight if possible.",
                    "Cook rice according to packet instructions. Cool and refrigerate.",
                    "Heat pan over medium-high heat. Cook chicken for 6-7 minutes each side until cooked through. Slice and cool.",
                    "Dice cucumber, halve tomatoes, and thinly slice red onion.",
                    "To assemble: divide rice between bowls. Top with sliced chicken, cucumber, tomatoes, and red onion.",
                    "Crumble feta over the top.",
                    "Add a generous spoonful of tzatziki to serve."
                ]
            },
            {
                name: "Chicken and Halloumi Traybake",
                calories: 740, protein: 67, carbs: 22, fat: 41,
                prepNote: "Roast the night before. Reheats well in 3 minutes in microwave or eat cold.",
                ingredients: [
                    { item: "Chicken breasts", qty: "2 (400g)", category: "Meat & Fish" },
                    { item: "Halloumi", qty: "200g", category: "Dairy" },
                    { item: "Bell peppers", qty: "2 (mixed colors)", category: "Vegetables" },
                    { item: "Courgette", qty: "1 large", category: "Vegetables" },
                    { item: "Red onion", qty: "1", category: "Vegetables" },
                    { item: "Cherry tomatoes", qty: "200g", category: "Vegetables" },
                    { item: "Olive oil", qty: "2 tbsp", category: "Cooking" },
                    { item: "Dried oregano", qty: "1 tsp", category: "Cooking" },
                    { item: "Smoked paprika", qty: "1 tsp", category: "Cooking" },
                    { item: "Salt and pepper", qty: "To taste", category: "Cooking" }
                ],
                method: [
                    "Preheat oven to 200°C. Slice peppers, courgette, and red onion into chunks.",
                    "Toss vegetables with 1 tbsp olive oil, oregano, paprika, salt and pepper. Spread on large baking tray.",
                    "Cut chicken into large chunks. Toss with remaining oil and season. Add to tray.",
                    "Roast for 20 minutes.",
                    "Slice halloumi into thick pieces. Add to tray alongside cherry tomatoes.",
                    "Roast for further 10-12 minutes until halloumi is golden and chicken cooked through.",
                    "Cool completely, portion into containers and refrigerate. Reheat or serve cold."
                ]
            },
            {
                name: "Tuna Nicoise Salad",
                calories: 715, protein: 57, carbs: 26, fat: 41,
                prepNote: "Boil eggs and potatoes the night before. Assemble salad in the morning. Keep dressing separate until serving.",
                ingredients: [
                    { item: "Tuna in spring water", qty: "2 cans (240g drained)", category: "Meat & Fish" },
                    { item: "Eggs", qty: "6 (3 per person)", category: "Dairy" },
                    { item: "Green beans", qty: "200g", category: "Vegetables" },
                    { item: "Baby potatoes", qty: "200g", category: "Vegetables" },
                    { item: "Black olives", qty: "100g", category: "Vegetables" },
                    { item: "Cherry tomatoes", qty: "100g", category: "Vegetables" },
                    { item: "Olive oil", qty: "2 tbsp", category: "Cooking" },
                    { item: "Dijon mustard", qty: "1 tsp", category: "Cooking" },
                    { item: "Red wine vinegar", qty: "1 tbsp", category: "Cooking" },
                    { item: "Salt and pepper", qty: "To taste", category: "Cooking" }
                ],
                method: [
                    "Boil baby potatoes for 12-15 minutes until tender. Drain and cool.",
                    "Soft boil eggs for 6-7 minutes. Cool in cold water, peel and halve.",
                    "Blanch green beans in boiling water for 3 minutes. Drain and cool.",
                    "Make dressing: whisk olive oil, dijon mustard, red wine vinegar, salt and pepper.",
                    "Arrange potatoes, green beans, cherry tomatoes, and olives in containers.",
                    "Top with drained tuna flaked over the salad and halved eggs.",
                    "Keep dressing in a small separate container. Dress just before eating."
                ]
            },
            {
                name: "Turkey and Hummus Flatbread",
                calories: 749, protein: 54, carbs: 54, fat: 33,
                prepNote: "Slice turkey and prep toppings the night before. Assemble in the morning and wrap tightly.",
                ingredients: [
                    { item: "Turkey breast", qty: "300g sliced", category: "Meat & Fish" },
                    { item: "Large flatbreads", qty: "2", category: "Cooking" },
                    { item: "Hummus", qty: "150g", category: "Cooking" },
                    { item: "Roasted peppers (jarred)", qty: "100g", category: "Vegetables" },
                    { item: "Feta cheese", qty: "60g", category: "Dairy" },
                    { item: "Avocado", qty: "1 large", category: "Vegetables" },
                    { item: "Rocket", qty: "100g", category: "Vegetables" },
                    { item: "Lemon", qty: "Half", category: "Vegetables" },
                    { item: "Salt and pepper", qty: "To taste", category: "Cooking" }
                ],
                method: [
                    "If cooking turkey from scratch: season and pan fry in a little oil for 5-6 minutes each side. Slice and cool.",
                    "Slice avocado and squeeze lemon juice over to prevent browning.",
                    "Lay flatbreads flat. Spread hummus generously over each.",
                    "Layer rocket, turkey slices, roasted peppers, avocado, and crumbled feta.",
                    "Season with salt and pepper.",
                    "Roll tightly and wrap in foil or cling film.",
                    "Refrigerate overnight and slice in half to serve."
                ]
            },
            {
                name: "Egg Fried Rice with Edamame and Prawns",
                calories: 758, protein: 51, carbs: 69, fat: 30,
                prepNote: "Best made with day-old cold rice. Cook rice the night before and refrigerate uncovered to dry out slightly.",
                ingredients: [
                    { item: "Cooked king prawns", qty: "250g", category: "Meat & Fish" },
                    { item: "Eggs", qty: "4", category: "Dairy" },
                    { item: "Jasmine rice", qty: "150g uncooked", category: "Cooking" },
                    { item: "Edamame beans (shelled)", qty: "150g", category: "Vegetables" },
                    { item: "Spring onions", qty: "4", category: "Vegetables" },
                    { item: "Soy sauce", qty: "2 tbsp", category: "Cooking" },
                    { item: "Sesame oil", qty: "1 tbsp", category: "Cooking" },
                    { item: "Vegetable oil", qty: "1 tbsp", category: "Cooking" },
                    { item: "Garlic cloves", qty: "2", category: "Vegetables" },
                    { item: "Fresh ginger", qty: "1cm piece", category: "Vegetables" }
                ],
                method: [
                    "Cook rice the night before and refrigerate uncovered to dry out.",
                    "Heat veg oil in wok over high heat. Add cold rice, stir-fry for 3-4 minutes until heated through.",
                    "Push rice to one side. Crack eggs into the wok, scramble until just set then mix through rice.",
                    "Add minced garlic and ginger, cook for 30 seconds.",
                    "Add prawns and edamame, stir-fry for 2 minutes until heated through.",
                    "Add soy sauce and sesame oil, toss everything together.",
                    "Garnish with sliced spring onions. Portion into containers and cool before refrigerating."
                ]
            }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            const searchBox = document.getElementById('searchBox');
            if (searchBox) {
                searchBox.addEventListener('input', function(e) {
                    const query = e.target.value.toLowerCase();
                    document.querySelectorAll('.meal-card').forEach(card => {
                        const title = card.querySelector('.meal-title').textContent.toLowerCase();
                        card.classList.toggle('hidden', query.length > 0 && !title.includes(query));
                    });
                });
            }
        });

        function renderMacros(meal) {
            return `<div class="macros">
                <span class="macro-badge">${meal.calories} cal</span>
                <span class="macro-badge protein">${meal.protein}g protein</span>
                <span class="macro-badge carbs">${meal.carbs}g carbs</span>
                <span class="macro-badge fat">${meal.fat}g fat</span>
            </div>`;
        }

        function renderCard(meal, index, showCheckbox, dayLabel) {
            return `<div class="meal-card" data-index="${index}">
                <div class="meal-header">
                    <div class="meal-header-left">
                        ${showCheckbox ? `<input type="checkbox" class="meal-checkbox" id="meal-${index}" checked>` : ''}
                        <div class="meal-title">${dayLabel ? dayLabel + ': ' : ''}${meal.name}</div>
                    </div>
                    ${renderMacros(meal)}
                </div>
                <div class="meal-content">
                    ${meal.prepNote ? `<div class="prep-note">Prep tip: ${meal.prepNote}</div>` : ''}
                    <div class="section-title">Ingredients (serves 2):</div>
                    <ul class="ingredients-list">
                        ${meal.ingredients.map(ing => `<li>${ing.qty} ${ing.item}</li>`).join('')}
                    </ul>
                    <div class="section-title">Method:</div>
                    <ol class="method-list">
                        ${meal.method.map(step => `<li>${step}</li>`).join('')}
                    </ol>
                </div>
            </div>`;
        }

        function showAll() {
            document.getElementById('searchBox').value = '';
            currentMeals = mealDatabase;
            document.getElementById('meals').innerHTML = mealDatabase.map((meal, i) => renderCard(meal, i, false, null)).join('');
            document.getElementById('shopping').innerHTML = '';
        }

        function shuffleArray(array) {
            const a = [...array];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function generateWeek() {
            const selected = shuffleArray(mealDatabase).slice(0, 2);
            currentMeals = selected;
            const days = ['WFH Day 1', 'WFH Day 2'];
            document.getElementById('meals').innerHTML = selected.map((meal, i) => renderCard(meal, i, true, days[i])).join('');
            document.getElementById('shopping').innerHTML = generateShoppingList(selected);
        }

        function generateShoppingList(meals) {
            const categories = { "Meat & Fish": [], "Vegetables": [], "Dairy": [], "Fresh Herbs": [], "Cooking": [] };
            const itemMap = {};
            meals.forEach(meal => {
                meal.ingredients.forEach(ing => {
                    const key = ing.item.toLowerCase();
                    if (!itemMap[key]) { itemMap[key] = { item: ing.item, qty: ing.qty, category: ing.category }; }
                    else { itemMap[key].qty += ', ' + ing.qty; }
                });
            });
            Object.values(itemMap).forEach(ing => { if (categories[ing.category]) categories[ing.category].push(`${ing.item} (${ing.qty})`); });
            let html = '<div class="shopping-list"><h2>Waitrose Shopping List</h2>';
            Object.entries(categories).forEach(([cat, items]) => {
                if (items.length > 0) {
                    html += `<div class="shopping-category"><div class="category-name">${cat}</div>
                        <ul class="shopping-items">${items.map(i => `<li>${i}</li>`).join('')}</ul></div>`;
                }
            });
            return html + '</div>';
        }

        async function createRecipeImage(meal, dayLabel) {
            const d = document.createElement('div');
            d.style.cssText = 'width:800px;padding:30px;background:#fff;font-family:-apple-system,sans-serif;position:absolute;left:-9999px;';
            d.innerHTML = `
                <div style="margin-bottom:20px;padding-bottom:15px;border-bottom:3px solid #2980b9;">
                    <h2 style="color:#2c3e50;font-size:22px;margin-bottom:10px;">${dayLabel ? dayLabel + ': ' : ''}${meal.name}</h2>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <span style="background:#2980b9;color:white;padding:4px 10px;border-radius:4px;font-size:13px;font-weight:600;">${meal.calories} cal</span>
                        <span style="background:#e74c3c;color:white;padding:4px 10px;border-radius:4px;font-size:13px;font-weight:600;">${meal.protein}g protein</span>
                        <span style="background:#f39c12;color:white;padding:4px 10px;border-radius:4px;font-size:13px;font-weight:600;">${meal.carbs}g carbs</span>
                        <span style="background:#7f8c8d;color:white;padding:4px 10px;border-radius:4px;font-size:13px;font-weight:600;">${meal.fat}g fat</span>
                    </div>
                    ${meal.prepNote ? `<div style="margin-top:10px;padding:8px 12px;background:#eaf4fb;border-left:3px solid #2980b9;font-size:13px;color:#555;">Prep tip: ${meal.prepNote}</div>` : ''}
                </div>
                <div style="margin-bottom:20px;">
                    <h3 style="color:#34495e;font-size:17px;margin-bottom:10px;">Ingredients (serves 2):</h3>
                    <ul style="list-style:none;padding:0;color:#555;line-height:1.8;">${meal.ingredients.map(i => `<li>• ${i.qty} ${i.item}</li>`).join('')}</ul>
                </div>
                <div>
                    <h3 style="color:#34495e;font-size:17px;margin-bottom:10px;">Method:</h3>
                    <ol style="padding-left:20px;color:#555;line-height:1.8;">${meal.method.map(s => `<li style="margin-bottom:8px;">${s}</li>`).join('')}</ol>
                </div>`;
            document.body.appendChild(d);
            const canvas = await html2canvas(d, { backgroundColor: '#ffffff', scale: 2 });
            document.body.removeChild(d);
            return canvas;
        }

        function downloadCanvas(canvas, filename) {
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.download = filename; a.href = url; a.click();
                URL.revokeObjectURL(url);
            });
        }

        async function downloadSelected() {
            const boxes = document.querySelectorAll('.meal-checkbox:checked');
            if (boxes.length === 0) { alert('Please select at least one lunch!'); return; }
            for (let box of boxes) {
                const i = parseInt(box.id.split('-')[1]);
                const meal = currentMeals[i];
                const canvas = await createRecipeImage(meal, `WFH Day ${i + 1}`);
                downloadCanvas(canvas, `wfh-lunch-${i + 1}-${meal.name.replace(/\s+/g, '-').toLowerCase()}.png`);
                await new Promise(r => setTimeout(r, 500));
            }
        }

        async function downloadGroceryList() {
            if (currentMeals.length === 0) { alert('Please generate lunches first!'); return; }
            const categories = { "Meat & Fish": [], "Vegetables": [], "Dairy": [], "Fresh Herbs": [], "Cooking": [] };
            const itemMap = {};
            currentMeals.forEach(meal => {
                meal.ingredients.forEach(ing => {
                    const key = ing.item.toLowerCase();
                    if (!itemMap[key]) { itemMap[key] = { item: ing.item, qty: ing.qty, category: ing.category }; }
                    else { itemMap[key].qty += ', ' + ing.qty; }
                });
            });
            Object.values(itemMap).forEach(ing => { if (categories[ing.category]) categories[ing.category].push(`${ing.item} (${ing.qty})`); });
            const d = document.createElement('div');
            d.style.cssText = 'width:800px;padding:30px;background:#eaf4fb;font-family:-apple-system,sans-serif;position:absolute;left:-9999px;border:3px solid #2980b9;border-radius:8px;';
            let html = `<h2 style="color:#1a6a9a;font-size:24px;margin-bottom:20px;">Waitrose Shopping List - WFH Lunches</h2>`;
            Object.entries(categories).forEach(([cat, items]) => {
                if (items.length > 0) {
                    html += `<div style="margin-bottom:18px;"><h3 style="color:#34495e;font-size:16px;margin-bottom:8px;">${cat}</h3>
                        <ul style="list-style:none;padding-left:15px;color:#555;line-height:1.7;">${items.map(i => `<li>• ${i}</li>`).join('')}</ul></div>`;
                }
            });
            d.innerHTML = html;
            document.body.appendChild(d);
            const canvas = await html2canvas(d, { backgroundColor: '#eaf4fb', scale: 2 });
            document.body.removeChild(d);
            downloadCanvas(canvas, 'wfh-lunch-shopping-list.png');
        }

        generateWeek();
    </script>
</body>
</html>
